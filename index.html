<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Master - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ 3D –∫—É–±–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            text-align: center;
            overflow-x: hidden;
        }
        .container { width: 100%; max-width: 400px; }
        .header { margin-bottom: 1.5rem; z-index: 10; }
        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab-button {
            background: rgba(255, 255, 255, 0.1); border: none; padding: 10px 15px;
            border-radius: 20px; color: white; cursor: pointer; font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab-button:hover { background: rgba(255, 255, 255, 0.2); }
        .tab-button.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .dice-content { display: none; }
        .dice-content.active { display: block; }
        .dice-scene { width: 200px; height: 200px; margin: 1.5rem auto; position: relative; }
        .dice-canvas { width: 100%; height: 100%; border-radius: 15px; }
        .dice-number {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; color: white;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
            z-index: 100; opacity: 0; transition: all 0.5s ease;
        }
        .tab-button.locked {
            opacity: 0.6; cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05) !important;
        }
        .tab-button.locked::after { content: " üîí"; font-size: 0.8em; }
        .lock-message {
            background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 10px; border-radius: 10px; margin: 10px 0; font-size: 0.9rem;
        }
        .auto-roll-status {
            font-size: 1.2rem; margin: 1.5rem 0; color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
        .particle {
            position: absolute; background: rgba(255, 255, 255, 0.3); border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }
        @keyframes float { 0%,100%{transform:translateY(0) rotate(0)} 50%{transform:translateY(-20px) rotate(180deg)} }
        @keyframes numberAppear {
            0%{transform:translate(-50%,-50%) scale(0);opacity:0;}
            70%{transform:translate(-50%,-50%) scale(1.2);opacity:.8;}
            100%{transform:translate(-50%,-50%) scale(1);opacity:1;}
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="container">
        <div class="header">
            <h1>üé≤ Dice Master</h1>
            <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ 3D –∫—É–±–∏–∫–∏</p>
        </div>

        <div class="tabs">
            <button class="tab-button locked" data-tab="d4">D4</button>
            <button class="tab-button locked" data-tab="d6">D6</button>
            <button class="tab-button locked" data-tab="d8">D8</button>
            <button class="tab-button locked" data-tab="d10">D10</button>
            <button class="tab-button locked" data-tab="d12">D12</button>
            <button class="tab-button locked" data-tab="d20">D20</button>
        </div>

        <div id="lockMessage" class="lock-message" style="display: none;">
            ‚ö†Ô∏è –≠—Ç–æ—Ç –∫—É–±–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ—Å–∫–∞. –ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω—ã–π –∫—É–±–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫—É–±–∏–∫–æ–≤ -->
        <div class="dice-content" id="d4-content"><div class="dice-scene"><canvas class="dice-canvas" id="d4-canvas"></canvas><div class="dice-number" id="d4-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
        <div class="dice-content" id="d6-content"><div class="dice-scene"><canvas class="dice-canvas" id="d6-canvas"></canvas><div class="dice-number" id="d6-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
        <div class="dice-content" id="d8-content"><div class="dice-scene"><canvas class="dice-canvas" id="d8-canvas"></canvas><div class="dice-number" id="d8-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
        <div class="dice-content" id="d10-content"><div class="dice-scene"><canvas class="dice-canvas" id="d10-canvas"></canvas><div class="dice-number" id="d10-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
        <div class="dice-content" id="d12-content"><div class="dice-scene"><canvas class="dice-canvas" id="d12-canvas"></canvas><div class="dice-number" id="d12-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
        <div class="dice-content" id="d20-content"><div class="dice-scene"><canvas class="dice-canvas" id="d20-canvas"></canvas><div class="dice-number" id="d20-number"></div></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand(); tg.BackButton.hide();
        const urlParams = new URLSearchParams(window.location.search);
        const allowedDice = urlParams.get('dice') || 'd20';

        const diceColors = {
            d4:{primary:'#FF6B6B',secondary:'#FF8E8E',gradient:['#FF6B6B','#FF8E8E']},
            d6:{primary:'#4ECDC4',secondary:'#44A08D',gradient:['#4ECDC4','#44A08D']},
            d8:{primary:'#FFD93D',secondary:'#FF9A3D',gradient:['#FFD93D','#FF9A3D']},
            d10:{primary:'#6BCF7F',secondary:'#4CAF50',gradient:['#6BCF7F','#4CAF50']},
            d12:{primary:'#9B59B6',secondary:'#8E44AD',gradient:['#9B59B6','#8E44AD']},
            d20:{primary:'#3498DB',secondary:'#2980B9',gradient:['#3498DB','#2980B9']}
        };
        const resultColors = {critical:'#4ecdc4',success:'#ffd700',normal:'#ffa86b',failure:'#ff6b6b'};

        // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∫—É–±–∏–∫–æ–≤
        const diceOrientations = {
            d4: [
                {x:0,y:0,z:0},{x:Math.PI/2,y:0,z:0},{x:-Math.PI/2,y:0,z:0},{x:Math.PI,y:0,z:0}
            ],
            d6: [
                {x:0,y:0,z:0},{x:Math.PI,y:0,z:0},{x:Math.PI/2,y:0,z:0},
                {x:-Math.PI/2,y:0,z:0},{x:0,y:Math.PI/2,z:0},{x:0,y:-Math.PI/2,z:0}
            ],
            d8: Array.from({length:8},(_,i)=>({x:(i%4)*Math.PI/2,y:Math.floor(i/4)*Math.PI,z:0})),
            d10: Array.from({length:10},(_,i)=>({x:(i%5)*Math.PI/2.5,y:Math.floor(i/5)*Math.PI,z:0})),
            d12: Array.from({length:12},(_,i)=>({x:(i%4)*Math.PI/2,y:Math.floor(i/4)*Math.PI/2,z:0})),
            d20: Array.from({length:20},(_,i)=>({x:(i%5)*Math.PI/2.5,y:Math.floor(i/5)*Math.PI/2,z:0}))
        };

        class ModernDice3D {
            constructor(canvasId,type){
                this.canvas=document.getElementById(canvasId);
                this.type=type; this.sides=this.getSidesCount();
                this.numberElement=document.getElementById(`${type}-number`);
                this.isRolling=false; this.finalResult=null; this.rollCallback=null;
                this.idleAnimation=true; this.init();
            }
            getSidesCount(){return {d4:4,d6:6,d8:8,d10:10,d12:12,d20:20}[this.type]||6;}
            init(){
                this.scene=new THREE.Scene(); this.scene.background=new THREE.Color(0x1a1a2e);
                this.camera=new THREE.PerspectiveCamera(45,1,0.1,1000); this.camera.position.z=8;
                this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:true,alpha:true});
                this.renderer.setSize(200,200); this.renderer.setClearColor(0x000000,0);
                this.scene.add(new THREE.AmbientLight(0xffffff,0.5));
                const dirLight=new THREE.DirectionalLight(0xffffff,0.7); dirLight.position.set(3,5,5); this.scene.add(dirLight);
                this.createDice(); this.animate();
            }
            createDice(){
                const geometry=this.getGeometry(); const colors=diceColors[this.type];
                const material=new THREE.MeshPhongMaterial({color:colors.primary,shininess:60,specular:0x222222});
                this.dice=new THREE.Mesh(geometry,material); this.scene.add(this.dice);
            }
            getGeometry(){
                switch(this.type){
                    case 'd4':return new THREE.TetrahedronGeometry(2.8);
                    case 'd6':return new THREE.BoxGeometry(3.2,3.2,3.2);
                    case 'd8':return new THREE.OctahedronGeometry(2.8);
                    case 'd10':return new THREE.DodecahedronGeometry(2.5);
                    case 'd12':return new THREE.DodecahedronGeometry(2.5);
                    case 'd20':return new THREE.IcosahedronGeometry(2.8);
                    default:return new THREE.BoxGeometry(3.2,3.2,3.2);
                }
            }
            roll(callback){
                if(this.isRolling)return;
                this.isRolling=true; this.idleAnimation=false; this.rollCallback=callback;
                this.finalResult=Math.floor(Math.random()*this.sides)+1;
                if(this.numberElement){this.numberElement.style.opacity='0';this.numberElement.style.animation='none';}
                const targetRotation=diceOrientations[this.type][this.finalResult-1];
                const startRotation=this.dice.rotation.clone(); const startTime=Date.now();
                const fastDuration=1000, slowDuration=600;
                const animate=()=>{
                    const elapsed=Date.now()-startTime;
                    if(elapsed<fastDuration){
                        const p=elapsed/fastDuration,e=this.easeOutCubic(p);
                        this.dice.rotation.x=startRotation.x+(targetRotation.x-startRotation.x)*e;
                        this.dice.rotation.y=startRotation.y+(targetRotation.y-startRotation.y)*e;
                        this.dice.rotation.z=startRotation.z+(targetRotation.z-startRotation.z)*e;
                        requestAnimationFrame(animate);
                    }else if(elapsed<fastDuration+slowDuration){
                        const p=(elapsed-fastDuration)/slowDuration,e=this.easeOutCubic(p);
                        this.dice.rotation.x=targetRotation.x*e;
                        this.dice.rotation.y=targetRotation.y*e;
                        this.dice.rotation.z=targetRotation.z*e;
                        requestAnimationFrame(animate);
                    }else{
                        this.dice.rotation.set(targetRotation.x,targetRotation.y,targetRotation.z);
                        this.isRolling=false; this.showNumber();
                        if(this.rollCallback)this.rollCallback(this.finalResult);
                    }
                }; animate();
            }
            showNumber(){
                if(this.numberElement&&this.finalResult){
                    this.numberElement.textContent=this.finalResult;
                    this.numberElement.style.animation='numberAppear 0.6s ease-out';
                    this.numberElement.style.opacity='1';
                    const percent=(this.finalResult/this.sides)*100;
                    let c=percent>=80?resultColors.critical:percent>=50?resultColors.success:percent>=20?resultColors.normal:resultColors.failure;
                    this.numberElement.style.color=c; this.numberElement.style.textShadow=`0 0 20px ${c}80,0 0 30px ${c}80`;
                }
            }
            easeOutCubic(t){return 1-Math.pow(1-t,3);}
            animate(){requestAnimationFrame(()=>this.animate());
                if(!this.isRolling&&this.idleAnimation){this.dice.rotation.y+=0.005;this.dice.rotation.x+=0.002;}
                this.renderer.render(this.scene,this.camera);}
            setIdleAnimation(e){this.idleAnimation=e;}
        }

        function createParticles(){
            const c=document.getElementById('particles');
            for(let i=0;i<15;i++){const p=document.createElement('div');p.className='particle';
                p.style.width=Math.random()*6+2+'px';p.style.height=p.style.width;
                p.style.left=Math.random()*100+'%';p.style.top=Math.random()*100+'%';
                p.style.animationDelay=Math.random()*6+'s';p.style.animationDuration=Math.random()*4+4+'s';
                c.appendChild(p);}
        }

        function activateAllowedDice(diceType){
            document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.add('locked');btn.classList.remove('active');});
            document.querySelectorAll('.dice-content').forEach(c=>c.classList.remove('active'));
            const b=document.querySelector(`[data-tab="${diceType}"]`); const cont=document.getElementById(`${diceType}-content`);
            if(b&&cont){b.classList.remove('locked');b.classList.add('active');cont.classList.add('active');document.getElementById('lockMessage').style.display='none';}
        }

        document.querySelectorAll('.tab-button').forEach(button=>{
            button.addEventListener('click',()=>{
                if(button.classList.contains('locked')){
                    document.getElementById('lockMessage').style.display='block';
                    setTimeout(()=>{document.getElementById('lockMessage').style.display='none';},3000); return;}
                document.querySelectorAll('.dice-content').forEach(c=>c.classList.remove('active'));
                document.getElementById(`${button.getAttribute('data-tab')}-content`).classList.add('active');
            });
        });

        let autoRollExecuted=false; let diceInstances={};
        function initializeDice(){
            ['d4','d6','d8','d10','d12','d20'].forEach(type=>{
                const id=`${type}-canvas`; if(document.getElementById(id)){
                    try{diceInstances[type]=new ModernDice3D(id,type);}catch(e){console.error(`Error ${type}:`,e);}
                }
            });
        }
        function autoRollDice(){
            if(autoRollExecuted)return; autoRollExecuted=true;
            const diceType=allowedDice;
            if(diceInstances[diceType]){
                Object.values(diceInstances).forEach(d=>{if(d.setIdleAnimation)d.setIdleAnimation(false);});
                diceInstances[diceType].roll(finalResult=>{
                    setTimeout(()=>{
                        tg.sendData(JSON.stringify({action:"dice_roll",dice_type:diceType,value:finalResult}));
                        setTimeout(()=>{tg.close();},1500);
                    },1000);
                });
            }
        }
        document.addEventListener('DOMContentLoaded',()=>{createParticles();initializeDice();activateAllowedDice(allowedDice);setTimeout(autoRollDice,1000);});
    </script>
</body>
</html>




















