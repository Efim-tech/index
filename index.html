<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Master - 3D –ö—É–±–∏–∫–∏ —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: white;
      text-align: center;
      overflow-x: hidden;
    }
    .container { width: 100%; max-width: 400px; }
    .header { margin-bottom: 1.5rem; }
    .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tab-button {
      background: rgba(255, 255, 255, 0.1); border: none; padding: 10px 15px;
      border-radius: 20px; color: white; cursor: pointer; font-weight: bold;
      transition: all 0.3s ease;
    }
    .tab-button.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .tab-button.locked {
      opacity: 0.6; cursor: not-allowed;
      background: rgba(255, 255, 255, 0.05) !important;
    }
    .tab-button.locked::after { content: " üîí"; font-size: 0.8em; }
    .lock-message {
      background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3);
      padding: 10px; border-radius: 10px; margin: 10px 0; font-size: 0.9rem;
    }
    .dice-content { display: none; }
    .dice-content.active { display: block; }
    .dice-scene { width: 200px; height: 200px; margin: 1.5rem auto; position: relative; }
    .dice-canvas { width: 100%; height: 100%; border-radius: 15px; }
    .auto-roll-status {
      font-size: 1.2rem; margin: 1.5rem 0; color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    @keyframes numberAppear {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      70% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .particle {
      position: absolute; background: rgba(255, 255, 255, 0.3); border-radius: 50%;
      animation: float 6s infinite ease-in-out;
    }
    @keyframes float { 0%,100%{transform:translateY(0) rotate(0)} 50%{transform:translateY(-20px) rotate(180deg)} }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>
  <div class="container">
    <div class="header">
      <h1>üé≤ Dice Master</h1>
      <p>–ú–∞–≥–∏—á–µ—Å–∫–∏–µ 3D –∫—É–±–∏–∫–∏</p>
    </div>

    <div class="tabs">
      <button class="tab-button locked" data-tab="d4">D4</button>
      <button class="tab-button locked" data-tab="d6">D6</button>
      <button class="tab-button locked" data-tab="d8">D8</button>
      <button class="tab-button locked" data-tab="d10">D10</button>
      <button class="tab-button locked" data-tab="d12">D12</button>
      <button class="tab-button locked" data-tab="d20">D20</button>
    </div>

    <div id="lockMessage" class="lock-message" style="display: none;">
      ‚ö†Ô∏è –≠—Ç–æ—Ç –∫—É–±–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ—Å–∫–∞. –ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω—ã–π –∫—É–±–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
    <div id="d4-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d4-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    <div id="d6-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d6-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    <div id="d8-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d8-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    <div id="d10-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d10-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    <div id="d12-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d12-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
    <div id="d20-content" class="dice-content"><div class="dice-scene"><canvas class="dice-canvas" id="d20-canvas"></canvas></div><div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp; tg.expand(); tg.BackButton.hide();
    const urlParams = new URLSearchParams(window.location.search);
    const allowedDice = urlParams.get('dice') || 'd20';

    // üé® –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∏—á–µ—Å–∫–æ–π —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è –≥—Ä–∞–Ω–∏
    function createFaceTexture(text, bgColor="#111", textColor="#0ff") {
      const size = 256;
      const canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext("2d");

      // —Ñ–æ–Ω
      const gradient = ctx.createRadialGradient(size/2, size/2, 20, size/2, size/2, size/2);
      gradient.addColorStop(0, bgColor);
      gradient.addColorStop(1, "#000");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, size, size);

      // —Ü–∏—Ñ—Ä–∞
      ctx.font = "bold 140px Arial";
      ctx.fillStyle = textColor;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.shadowColor = textColor;
      ctx.shadowBlur = 30;
      ctx.fillText(text, size/2, size/2);

      return new THREE.CanvasTexture(canvas);
    }

    // üìå –¢–≤–æ–∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    const baseOrientations = {
      d4: {x:-0.66, y:-10.21, z:0},
      d6: {x:3.14, y:0.01, z:0},
      d8: {x:-2.46, y:-0.78, z:0},
      d10: {x:0.62, y:1.56, z:0},
      d12: {x:0.60, y:1.55, z:0},
      d20: {x:-1.10, y:-0.01, z:0}
    };

    class ModernDice3D {
      constructor(canvasId,type){
        this.canvas=document.getElementById(canvasId);
        this.type=type; this.sides=this.getSidesCount();
        this.isRolling=false; this.finalResult=null;
        this.init();
      }
      getSidesCount(){return {d4:4,d6:6,d8:8,d10:10,d12:12,d20:20}[this.type];}
      init(){
        this.scene=new THREE.Scene();
        this.camera=new THREE.PerspectiveCamera(45,1,0.1,1000);
        this.camera.position.z=6;
        this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:true,alpha:true});
        this.renderer.setSize(200,200);
        this.scene.add(new THREE.AmbientLight(0xffffff,0.6));
        const dl=new THREE.DirectionalLight(0xffffff,0.8); dl.position.set(3,5,5); this.scene.add(dl);

        const geometry=this.getGeometry();
        const materials=[];
        for(let i=1;i<=this.sides;i++){
          materials.push(new THREE.MeshStandardMaterial({
            map: createFaceTexture(i, "#111", "#0ff"),
            emissive: new THREE.Color(0x00ffff),
            emissiveIntensity: 0.6
          }));
        }
        this.dice=new THREE.Mesh(geometry,materials);
        this.scene.add(this.dice);
        this.animate();
      }
      getGeometry(){
        switch(this.type){
          case'd4':return new THREE.TetrahedronGeometry(2.5);
          case'd6':return new THREE.BoxGeometry(2.5,2.5,2.5);
          case'd8':return new THREE.OctahedronGeometry(2.5);
          case'd10':return new THREE.DodecahedronGeometry(2.3);
          case'd12':return new THREE.DodecahedronGeometry(2.5);
          case'd20':return new THREE.IcosahedronGeometry(2.5);
        }
      }
      roll(callback){
        if(this.isRolling)return;
        this.isRolling=true;
        this.finalResult=Math.floor(Math.random()*this.sides)+1;
        const base=baseOrientations[this.type];
        const target={x:base.x,y:base.y,z:base.z};
        const start={x:this.dice.rotation.x,y:this.dice.rotation.y,z:this.dice.rotation.z};
        const startTime=Date.now(); const duration=2000;
        const animateStep=()=>{
          const t=(Date.now()-startTime)/duration;
          if(t<1){
            const eased=this.easeOutCubic(t);
            this.dice.rotation.x=start.x+(target.x+6*Math.PI-start.x)*eased;
            this.dice.rotation.y=start.y+(target.y+6*Math.PI-start.y)*eased;
            this.dice.rotation.z=start.z+(target.z+6*Math.PI-start.z)*eased;
            requestAnimationFrame(animateStep);
          }else{
            this.dice.rotation.set(target.x,target.y,target.z);
            this.isRolling=false;
            if(callback)callback(this.finalResult);
          }
        };
        animateStep();
      }
      easeOutCubic(t){return 1-Math.pow(1-t,3);}
      animate(){requestAnimationFrame(()=>this.animate());this.renderer.render(this.scene,this.camera);}
    }

    let diceInstances={};
    function initializeDice(){
      ['d4','d6','d8','d10','d12','d20'].forEach(type=>{
        diceInstances[type]=new ModernDice3D(`${type}-canvas`,type);
      });
    }

    function activateAllowedDice(diceType){
      document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.add('locked');btn.classList.remove('active');});
      document.querySelectorAll('.dice-content').forEach(c=>c.classList.remove('active'));
      const b=document.querySelector(`[data-tab="${diceType}"]`);
      const cont=document.getElementById(`${diceType}-content`);
      if(b&&cont){b.classList.remove('locked');b.classList.add('active');cont.classList.add('active');document.getElementById('lockMessage').style.display='none';}
    }

    function createParticles(){
      const c=document.getElementById('particles');
      for(let i=0;i<15;i++){const p=document.createElement('div');p.className='particle';
        p.style.width=Math.random()*6+2+'px';p.style.height=p.style.width;
        p.style.left=Math.random()*100+'%';p.style.top=Math.random()*100+'%';
        p.style.animationDelay=Math.random()*6+'s';p.style.animationDuration=Math.random()*4+4+'s';
        c.appendChild(p);}
    }

    let autoRollExecuted=false;
    function autoRollDice(){
      if(autoRollExecuted)return; autoRollExecuted=true;
      const diceType=allowedDice;
      if(diceInstances[diceType]){
        diceInstances[diceType].roll(finalResult=>{
          setTimeout(()=>{
            tg.sendData(JSON.stringify({action:"dice_roll",dice_type:diceType,value:finalResult}));
            setTimeout(()=>{tg.close();},1500);
          },1000);
        });
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      createParticles(); initializeDice(); activateAllowedDice(allowedDice);
      setTimeout(autoRollDice,1000);
    });
  </script>
</body>
</html>


























