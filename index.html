<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Master - –¢–∞–≤–µ—Ä–Ω–∞ üé≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    /* === –°—Ç–∏–ª–∏ (—Ç—ë–º–Ω—ã–π, –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π —Å –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–º —Å—Ç–æ–ª–æ–º) === */
    body {
      font-family: 'Georgia', serif;
      
      background: linear-gradient(135deg,#271b12 0%, #3b2a17 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #e6dcc8;
      text-align: center;
      overflow-x: hidden;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
    }

    .fog-layer {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.06), transparent 70%),
                  radial-gradient(circle at 80% 80%, rgba(255,255,255,0.03), transparent 60%),
                  radial-gradient(circle at 20% 60%, rgba(255,255,255,0.04), transparent 65%);
      animation: fogMove 20s infinite linear;
      z-index: 1;
    }
    @keyframes fogMove {
      0% { transform: translate(0,0); }
      50% { transform: translate(-20px,10px); }
      100% { transform: translate(0,0); }
    }

    .container { width: 100%; max-width: 400px; position: relative; z-index: 2; }
    .header { margin-bottom: 1.5rem; text-shadow: 2px 2px 6px rgba(0,0,0,0.7); }
    .tabs { display:flex; justify-content:center; gap:5px; margin-bottom:1.5rem; flex-wrap:wrap; }
    .tab-button {
      background: rgba(0,0,0,0.45);
      border: none;
      padding: 10px 15px;
      border-radius: 20px;
      color: #e6dcc8;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s ease;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
    }
    .tab-button:hover { transform: translateY(-2px); }
    .tab-button.active {
      background: linear-gradient(45deg,#7f5a32,#4a2d18);
      box-shadow: 0 6px 18px rgba(0,0,0,0.55);
    }
    .tab-button.locked {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(0,0,0,0.32) !important;
    }
    .tab-button.locked::after { content: " üîí"; font-size: 0.8em; }

    .lock-message {
      background: rgba(60, 12, 12, 0.6);
      border: 1px solid rgba(255, 60, 60, 0.15);
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 0.9rem;
      color: #ffd7d7;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
    }

    .dice-content { display: none; }
    .dice-content.active { display: block; }

    .dice-scene {
      width: 300px;
      height: 300px;
      margin: 1.5rem auto;
      position: relative;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.6);
      overflow: hidden;
    }

    canvas.dice-canvas { width:100%; height:100%; display:block; border-radius:12px; }

    .dice-number {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: 800;
      color: #ffd700;
      text-shadow: 0 0 16px rgba(255,215,0,0.25), 0 3px 8px rgba(0,0,0,0.7);
      z-index: 100;
      opacity: 0;
      transition: all 0.45s ease;
      pointer-events: none;
    }

    .auto-roll-status {
      font-size: 1.1rem;
      margin-top: 12px;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255,215,0,0.18);
      font-weight: 700;
      animation: pulse 1.6s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.75} }

    @media (max-width:420px) {
      .dice-scene { width:180px; height:180px; }
      .dice-number { font-size:2.6rem; }
    }
  </style>
</head>
<body>

  <div class="fog-layer" aria-hidden="true"></div>

  <div class="container">
    <div class="header">
      <h1>üç∫ Dice Master</h1>
      <p>–ö–æ—Å—Ç–∏ –Ω–∞ —Å—Ç–æ–ª–µ —Ç–∞–≤–µ—Ä–Ω—ã</p>
    </div>

    <div class="tabs">
      <button class="tab-button locked" data-tab="d4">D4</button>
      <button class="tab-button locked" data-tab="d6">D6</button>
      <button class="tab-button locked" data-tab="d8">D8</button>
      <button class="tab-button locked" data-tab="d10">D10</button>
      <button class="tab-button locked" data-tab="d12">D12</button>
      <button class="tab-button locked" data-tab="d20">D20</button>
    </div>

    <div id="lockMessage" class="lock-message" style="display:none;">
      ‚ö†Ô∏è –≠—Ç–æ—Ç –∫—É–±–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ—Å–∫–∞. –ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω—ã–π –∫—É–±–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
    <div id="d4-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d4-canvas"></canvas>
        <div class="dice-number" id="d4-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>

    <div id="d6-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d6-canvas"></canvas>
        <div class="dice-number" id="d6-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>

    <div id="d8-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d8-canvas"></canvas>
        <div class="dice-number" id="d8-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>

    <div id="d10-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d10-canvas"></canvas>
        <div class="dice-number" id="d10-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>

    <div id="d12-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d12-canvas"></canvas>
        <div class="dice-number" id="d12-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>

    <div id="d20-content" class="dice-content">
      <div class="dice-scene">
        <canvas class="dice-canvas" id="d20-canvas"></canvas>
        <div class="dice-number" id="d20-number"></div>
      </div>
      <div class="auto-roll-status">üéØ –ë—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫...</div>
    </div>
  </div>

  <!-- –∞—É–¥–∏–æ  -->
  <audio id="dice-sound" preload="auto">
    <source id="dice-sound-src" src="./assets/dice_roll.mp3" type="audio/mpeg">
  </audio>

  <script>
    // === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º  ===
    const BG_IMAGE = './assets/wood.jpg';           
    const DICE_SOUND_SRC = './assets/dice_roll.mp3';

    // Telegram WebApp init (–µ—Å–ª–∏ –≤ WebApp)
    const tg = window.Telegram?.WebApp || window.TelegramWebApp || null;
    try { if (tg?.expand) tg.expand(); if (tg?.BackButton) tg.BackButton.hide(); } catch(e){/* ignore */ }

    // –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω (fallback‚Äî–≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ CSS –æ—Å—Ç–∞–Ω–µ—Ç—Å—è, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)
    (function setBg(){
      const img = new Image();
      img.onload = () => { document.body.style.backgroundImage = `url("${BG_IMAGE}")`; document.body.style.backgroundSize = 'cover'; };
      img.onerror = () => { console.info('–§–æ–Ω (wood.jpg) –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏', BG_IMAGE, '‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç.'); };
      img.src = BG_IMAGE;
    })();

    // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–≤—É–∫ 
    const diceSoundSrcEl = document.getElementById('dice-sound-src');
    if(diceSoundSrcEl) diceSoundSrcEl.src = DICE_SOUND_SRC;
    const diceSound = document.getElementById('dice-sound');

    // === –¶–≤–µ—Ç–∞ –∫—É–±–∏–∫–æ–≤ (—Ç—ë–º–Ω—ã–µ, –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ). 
    const diceColors = {
      d4:  '#6d2f2f', // —Ç—ë–º–Ω—ã–π –±–æ—Ä–¥–æ
      d6:  '#ffffff', // –±–µ–ª—ã–π (–æ—Å–æ–±—ã–π)
      d8:  '#7a5b2f', // —Ç—ë–º–Ω–æ–µ –∑–æ–ª–æ—Ç–æ/–¥—É–±
      d10: '#2f5b45', // –≥–ª—É–±–æ–∫–∏–π –∑–µ–ª—ë–Ω—ã–π
      d12: '#5a3f66', // —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
      d20: '#264056'  // –≥–ª—É–±–æ–∫–∏–π —Å–∏–Ω–∏–π
    };

    const resultColors = {
      critical: '#ffd700',
      success:  '#ffd700',
      normal:   '#ffa86b',
      failure:  '#ff6b6b'
    };

    // —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    const baseOrientations = {
      d4:  {x:-0.66, y:-10.21, z:0},
      d6:  {x:3.14,  y:0.01,   z:0},
      d8:  {x:-2.46, y:-0.78,  z:0},
      d10: {x:0.62,  y:1.56,   z:0},
      d12: {x:0.60,  y:1.55,   z:0},
      d20: {x:-1.10, y:-0.01,  z:0}
    };

    class ModernDice3D {
      constructor(canvasId, type) {
        this.canvas = document.getElementById(canvasId);
        this.type = type;
        this.sides = this.getSidesCount();
        this.numberElement = document.getElementById(`${type}-number`);
        this.isRolling = false;
        this.finalResult = null;
        this.init();
      }

      getSidesCount(){
        return {d4:4,d6:6,d8:8,d10:10,d12:12,d20:20}[this.type] || 6;
      }

      init(){
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
        this.camera.position.z = 7;

        this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true, alpha: true });
        this.renderer.setSize(300, 300);
        this.renderer.setClearColor(0x000000, 0);

        // —Å–≤–µ—Ç
        this.scene.add(new THREE.AmbientLight(0xffffff, 0.55));
        const dl = new THREE.DirectionalLight(0xffffff, 0.85);
        dl.position.set(3, 5, 5);
        this.scene.add(dl);

        // –º–∞—Ç–µ—Ä–∏–∞–ª
        const matColor = diceColors[this.type] || '#444444';
        const material = new THREE.MeshPhongMaterial({
          color: matColor,
          shininess: 25,
          specular: 0x222222
        });

        const geometry = this.getGeometry();
        this.dice = new THREE.Mesh(geometry, material);
        this.scene.add(this.dice);

        this.animate();
      }

      getGeometry(){
        switch(this.type){
          case 'd4':  return new THREE.TetrahedronGeometry(2.5);
          case 'd6':  return new THREE.BoxGeometry(2.5,2.5,2.5);
          case 'd8':  return new THREE.OctahedronGeometry(2.5);
          case 'd10': return new THREE.DodecahedronGeometry(2.3);
          case 'd12': return new THREE.DodecahedronGeometry(2.5);
          case 'd20': return new THREE.IcosahedronGeometry(2.5);
          default:    return new THREE.BoxGeometry(2.5,2.5,2.5);
        }
      }

      roll(callback){
        if(this.isRolling) return;
        this.isRolling = true;
        this.finalResult = Math.floor(Math.random() * this.sides) + 1;

        // –ø—Ä—è—á–µ–º —á–∏—Å–ª–æ
        if(this.numberElement){ this.numberElement.style.opacity = '0'; this.numberElement.style.animation = 'none'; }

        // play sound 
        if(diceSound){
          try{
            diceSound.currentTime = 0;
            const p = diceSound.play();
            if(p && p.catch) p.catch(()=>{/* ignore */});
          }catch(e){ /* ignore */ }
        }

        const base = baseOrientations[this.type] || {x:0,y:0,z:0};
        const target = { x: base.x, y: base.y, z: base.z };
        const start = { x: this.dice.rotation.x, y: this.dice.rotation.y, z: this.dice.rotation.z };

        // –≤–∏–∑—É–∞–ª—å–Ω–æ "–º–Ω–æ–≥–æ –æ–±–æ—Ä–æ—Ç–æ–≤" ‚Äî –∑–∞—Ç–µ–º –ø–ª–∞–≤–Ω—ã–π —Ñ–∏–Ω–∞–ª
        const spins = 3; // –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–∞ 
        const extra = spins * 2 * Math.PI;

        const fastPhase = 900; // ms
        const slowPhase = 900; // ms
        const total = fastPhase + slowPhase;
        const startTime = Date.now();

        const step = () => {
          const elapsed = Date.now() - startTime;
          if(elapsed < fastPhase){
            const p = elapsed / fastPhase;
            const e = this.easeOutCubic(p);
            this.dice.rotation.x = start.x + (target.x + extra - start.x) * e;
            this.dice.rotation.y = start.y + (target.y + extra - start.y) * e;
            this.dice.rotation.z = start.z + (target.z + extra - start.z) * e;
            requestAnimationFrame(step);
            return;
          }
          if(elapsed < total){
            const p = (elapsed - fastPhase) / slowPhase;
            const e = this.easeOutCubic(p);
            const from = { x: target.x + extra, y: target.y + extra, z: target.z + extra };
            this.dice.rotation.x = from.x + (target.x - from.x) * e;
            this.dice.rotation.y = from.y + (target.y - from.y) * e;
            this.dice.rotation.z = from.z + (target.z - from.z) * e;
            requestAnimationFrame(step);
            return;
          }
          // —Ñ–∏–Ω–∏—à: —Ç–æ—á–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è 
          this.dice.rotation.set(target.x, target.y, target.z);
          this.isRolling = false;
          this.showNumber();
          if(typeof callback === 'function') callback(this.finalResult);
        };

        step();
      }

      showNumber(){
        if(!this.numberElement || !this.finalResult) return;
        this.numberElement.textContent = this.finalResult;
        this.numberElement.style.animation = 'numberAppear 0.6s ease-out';
        this.numberElement.style.opacity = '1';

        // —Ü–≤–µ—Ç —á–∏—Å–ª–∞: –¥–ª—è d6 (–±–µ–ª—ã–π –∫—É–±) ‚Äî —Å—Ç–∞–≤–∏–º —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç
        if(this.type === 'd6'){
          this.numberElement.style.color = '#111111';
          this.numberElement.style.textShadow = '0 1px 2px rgba(0,0,0,0.6)';
          return;
        }

        const percent = (this.finalResult / this.sides) * 100;
        let color = resultColors.normal;
        if(percent >= 80) color = resultColors.critical;
        else if(percent >= 50) color = resultColors.success;
        else if(percent < 20) color = resultColors.failure;
        this.numberElement.style.color = color;
        this.numberElement.style.textShadow = `0 0 20px ${color}80, 0 0 30px ${color}80`;
      }

      easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      animate(){
        requestAnimationFrame(()=>this.animate());
        this.renderer.render(this.scene, this.camera);
      }
    }

    // === UI / init ===
    let diceInstances = {};
    function initializeDice(){
      ['d4','d6','d8','d10','d12','d20'].forEach(type=>{
        const id = `${type}-canvas`;
        if(document.getElementById(id)){
          try{ diceInstances[type] = new ModernDice3D(id, type); } catch(e){ console.error('dice init error', type, e); }
        }
      });
    }

    function activateAllowedDice(diceType){
      document.querySelectorAll('.tab-button').forEach(btn=>{ btn.classList.add('locked'); btn.classList.remove('active'); });
      document.querySelectorAll('.dice-content').forEach(c=>c.classList.remove('active'));
      const b = document.querySelector(`[data-tab="${diceType}"]`);
      const cont = document.getElementById(`${diceType}-content`);
      if(b && cont){ b.classList.remove('locked'); b.classList.add('active'); cont.classList.add('active'); document.getElementById('lockMessage').style.display='none'; }
    }

    document.querySelectorAll('.tab-button').forEach(button=>{
      button.addEventListener('click', ()=>{
        if(button.classList.contains('locked')){
          const lm = document.getElementById('lockMessage');
          lm.style.display = 'block';
          setTimeout(()=>{ lm.style.display='none'; }, 2800);
          return;
        }
        // –µ—Å–ª–∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–ª–∞–¥–∫–∏)
        document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.dice-content').forEach(c=>c.classList.remove('active'));
        const id = button.getAttribute('data-tab');
        const cont = document.getElementById(`${id}-content`);
        if(cont) cont.classList.add('active');
      });
    });

    const urlParams = new URLSearchParams(window.location.search);
    const allowedDice = urlParams.get('dice') || 'd20';
    let autoRollExecuted = false;

    function autoRollDice(){
      if(autoRollExecuted) return;
      autoRollExecuted = true;
      if(diceInstances[allowedDice]){
        diceInstances[allowedDice].roll((finalResult) => {
          setTimeout(()=>{
            // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            try{
              if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.sendData === 'function'){
                Telegram.WebApp.sendData(JSON.stringify({ action: 'dice_roll', dice_type: allowedDice, value: finalResult }));
              } else if (tg && typeof tg.sendData === 'function') {
                tg.sendData(JSON.stringify({ action: 'dice_roll', dice_type: allowedDice, value: finalResult }));
              }
            }catch(e){ console.warn('sendData error', e); }
            // –∑–∞–∫—Ä—ã—Ç–∏–µ WebApp ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º: tg.close() –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            // setTimeout(()=>{ if(tg && typeof tg.close === 'function') tg.close(); }, 1200);
          }, 900);
        });
      } else {
        console.warn('autoRollDice: instance missing for', allowedDice);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // —É—Å—Ç–∞–Ω–æ–≤–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞ 
      const snd = document.getElementById('dice-sound-src');
      if(snd) snd.src = DICE_SOUND_SRC;

      initializeDice();
      activateAllowedDice(allowedDice);
      setTimeout(autoRollDice, 900);
    });
  </script>
</body>
</html>






























